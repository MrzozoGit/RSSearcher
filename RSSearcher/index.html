<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewporst" content="width=device-width, initial-scale=1.0">
    <title>(3.36) In-Game RSS</title>
    <link href="style/reset.css" rel="stylesheet">
    <link href="style/monStyle.css" rel="stylesheet">
</head>
<body>
    <div class="addFluxOverlay"></div>
    <div class="addFluxBox">
        <input class="addFluxOverlay_box_inputText" type="url"></input>
        <img class="addFluxOverlay_box_addButton" src="data/svg/plus.svg">
    </div>

    <header class="navbar">
        <img src="data/img/igLogo.png" alt="In-Game RSS" class="nav_igLogo">
        <section class="nav_rssSection">
            <ul class="nav_rssSection_list">
                <li class="nav_rssSection_list_li">
                    <img class="nav_rssSection_list_li_plus" src="data/svg/plus.svg">
                </li>
            </ul>
        </section>
    </header>
    <section class="main">
        <nav class="main_top">
            <img src="data/svg/star.svg" alt="" class="main_top_fav">
            <img src="data/svg/chronoR.svg" alt="" class="main_top_sort">
            <div class="main_top_categoryBox">
                <img class="main_top_categoryBox_arrow" src="data/svg/arrow.svg">
                <span class="main_top_categoryBox_text">Catégories</span>
                <ul class="main_top_categoryBox_list">
                    <li class="main_top_categoryBox_list_li">
                        <span class="main_top_categoryBox_list_li_text">Jeux vidéo</span>
                    </li>
                    <li class="main_top_categoryBox_list_li">
                        <span class="main_top_categoryBox_list_li_text">Pixels</span>
                    </li>
                    <li class="main_top_categoryBox_list_li">
                        <span class="main_top_categoryBox_list_li_text">Cultures web</span>
                    </li>
                    <li class="main_top_categoryBox_list_li">
                        <span class="main_top_categoryBox_list_li_text">Toute l'actualité</span>
                    </li>
                </ul>
            </div>
            <div class="main_top_searchbarBox">
                <input class="main_top_searchbarBox_search"></input>
                <img class="main_top_searchbarBox_button" src="data/svg/search.svg">
            </div>
        </nav>

        <section class="itemSection">
            <!-- <h2 class="itemSection_title">Liste des articles</h2> -->
            <ul class="itemSection_list">
                <!-- ELEMENTS TEMPORAIRES POUR FAIRE LE CSS -->
                <!-- <li class="itemSection_list_li">
                    <a href="" class="itemSection_list_li_linkImg"><img src="https://i.ytimg.com/vi/34YnyCKZPOQ/maxresdefault.jpg" alt="" class="itemSection_list_li_img"></a>
                    <h3 class="itemSection_list_li_title"><a href="" class="itemSection_list_li_link">Jeu vidéo : « Minecraft Earth » fermera ses portes en juin</a></h3>
                    <span class="itemSection_list_li_date">Wed, 06 Jan 2021 12:51:37 +0100</span>
                    <p class="itemSection_list_li_desc">Lancé il y a à peine un an, le jeu pour smartphone en réalité augmentée, qui transposait l’univers et les briques de « Minecraft » dans un titre inspiré du phénomène « Pokémon Go », a pâti du confinement mondial d’une bonne partie de la population en 2020.</p>
                </li> -->
            </ul>
        </section>
    </section>
    
    <script>

        let m = {
            data: null,
            idCounter: 0,
            sourcesUrlList: ['https://www.jeuxactu.com/rss/ja.rss', 'https://www.lemonde.fr/pixels/rss_full.xml', 'https://www.lemonde.fr/jeux-video/rss_full.xml', 'https://www.lemonde.fr/cultures-web/rss_full.xml'],
            sourcesList: [],
            currentArticles: [],

            init: function() {
                m.initFlux();
                m.sourcesUrlList.forEach(e => {
                    m.createFluxObj(e);
                });
            },

            initFlux: function() {
                flux = JSON.parse(localStorage.getItem("flux"));
                if (flux != null){
                    m.sourcesUrlList = flux;
                }
            },

            addFluxUrl: function(url) {
                m.sourcesUrlList.push(url);
                m.updateLocalFlux();
            },

            createFluxObj: function(url) {
                tempObj = tempObj = {'id': 'id' + m.idCounter, 'name': null, 'sourceUrl': url, 'switch': false, 'fav': false, articles: []};
                m.sourcesList.push(tempObj);
                m.idCounter++;
                //return tempObj;
            },

            updateLocalFlux: function() {
                localStorage.setItem("flux", JSON.stringify(m.sourcesUrlList));
            },
            
            addFav: function(source, sw) {
                source.fav = sw;
                m.updateLocalFav();
            },

            initFav: function() {
                favs = JSON.parse(localStorage.getItem("favs"));
                favs.forEach(e => {
                    m.sourcesList.forEach(f => {
                        if (f.sourceUrl == e)
                            f.fav = true;
                    })
                });
            },

            updateLocalFav: function() {
                let favTab = [];
                m.sourcesList.forEach(e => {
                    if (e.fav){
                        favTab.push(e.sourceUrl);
                    }
                });
                localStorage.setItem("favs", JSON.stringify(favTab));
            },

            filterFlux: function() {
                m.currentArticles = [];
                sourcesSwitch = m.sourcesList.filter(e => e.switch == true);
                sourcesSwitch.forEach(e => {
                    e.articles.forEach(f => {
                        m.currentArticles.push(f);
                    });
                });
            },

            filterFav: function() {
                m.currentArticles = [];
                sourcesFav = m.sourcesList.filter(e => e.fav == true);
                sourcesFav.forEach(e => {
                    e.articles.forEach(f => {
                        m.currentArticles.push(f);
                    });
                });
                return sourcesFav;
            }
        }

        let c = {
            init: function() {
                m.init();
                // m.sourcesList.forEach(e => {
                //     setTimeout(async function() {
                //         //c.fetchRSS(e);
                //         await c.fetchRSS(e);
                //     },1000);
                //     v.renderFlux(e);
                // });
                m.sourcesList.forEach(e => {
                    c.fetchRSS(e);
                });
                m.initFav();
                v.init();
            },

            fetchRSS: function(source) {
                let xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.status==200 && xhr.readyState==4) {
                        m.data = JSON.parse(xhr.responseText);
                        if (m.data != false) {
                            source.name = m.data.channel.title;
                            m.data.channel.item.forEach(e => {
                                source.articles.push({'article': e, 'id': source.id});
                            });
                            v.renderFlux(source);
                            v.renderFav(source);
                        }
                    }
                };
                xhr.open('get', "https://quentin-huet.fr/pt3/script/getRss.php?flux=" + source.sourceUrl);
                xhr.send();
            },

            // fetchRSS_REC: function(urls, pos) {
            //     let xhr = new XMLHttpRequest();
            //     xhr.onreadystatechange = function() {
            //         if (xhr.status==200 && xhr.readyState==4) {
            //             m.data = JSON.parse(xhr.responseText);
            //             if (pos+1<urls.length)
            //                 fetchRSS_REC(urls, pos+1);
            //             else{
            //                 // tous les flux sont chargés (affichage et tout)
            //             }
            //         }
            //     };
            //     xhr.open('get', "https://quentin-huet.fr/pt/script/getRss.php?flux=" + urls[pos]);
            //     xhr.send();
            // },

            updateArticles: function(){
                m.filterFlux();
                v.renderArticles(m.currentArticles);
            },

            handlerClickFlux: function(source, target) {
                if (source.switch == false) {
                    source.switch = true;
                    c.updateArticles();
                    v.fluxBrightness(target, '1', 'target');
                } else {
                    source.switch = false;
                    c.updateArticles();
                    v.fluxBrightness(target, '.5', 'target');
                }
            },

            resetFlux: function(){
                m.currentArticles = [];
                v.renderArticles();
                m.sourcesList.forEach(e => {
                    if (e.switch == true){
                        e.switch = false;
                        v.fluxBrightness(e.id, '.5', 'id');
                    }
                });
            },

            handlerAddFlux: function() {
                str = v.addFluxInputText.value;
                alreadyAdded = false;
                if ((str.includes("https://") || str.includes("http://")) & (str.includes(".xml") || (str.includes(".rss")))) {
                    m.sourcesList.forEach(e => {
                        if (str == e.sourceUrl) {
                            alreadyAdded = true;
                        }      
                    })
                    if (alreadyAdded == false) {
                        m.addFluxUrl(str);
                        m.createFluxObj(str);
                        v.addFluxInputText.value = "";
                        v.hideOverlay();
                        // Il faut afficher le flux aussi !
                        // Pour l'instant il ne s'affiche qu'après un refresh
                    }
                }
            },

            handlerFav: function(source, target) {
                if (source.fav == false) {
                    m.addFav(source, true);
                    target.src = 'data/svg/favFull.svg';
                } else {
                    m.addFav(source, false);
                    target.src = 'data/svg/favEmpty.svg';
                }
            },

            handlerFilterFav: function() {
                c.resetFlux();
                //favFlux = m.filterFav();
                m.filterFav();
                v.renderArticles(m.currentArticles);
                //IL FAUT RECUPERER LA TARGET
                //v.fluxBrightness(v.fluxButton, 1);
            }
        }

        let v = {
            fluxList: document.querySelector('.nav_rssSection_list'),
            itemList: document.querySelector('.itemSection_list'),
            addFluxPlus: document.querySelector('.nav_rssSection_list_li_plus'),
            addFluxOverlay: document.querySelector('.addFluxOverlay'),
            addFluxBox: document.querySelector('.addFluxBox'),
            addFluxInputText: document.querySelector('.addFluxOverlay_box_inputText'),
            addButton: document.querySelector('.addFluxOverlay_box_addButton'),
            filterFavButton: document.querySelector('.main_top_fav'),
            categoryBox: document.querySelector('main_top_categoryBox'),
            // note Quentin : faire bouger la petite flèche aussi


            init: function() {
                v.renderNav();
                v.renderArticles();
            },

            renderNav: function() {
                v.addFluxPlus.addEventListener('click', v.showOverlay);
                v.addFluxOverlay.addEventListener('click', v.hideOverlay);
                v.addButton.addEventListener('click', c.handlerAddFlux);
                // v.addFluxInputText.addEventListener('submit', c.handlerAddFlux);
                v.addFluxInputText.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        c.handlerAddFlux();
                    }
                });
                v.filterFavButton.addEventListener('click', c.handlerFilterFav);
                // v.categoryBox.addEventListener('click');
            },

            renderFlux: function(source) {
                if(source){
                    // Rendu du titre dans la liste des flux
                    itemFlux = document.createElement('li');
                    itemFlux.classList.add('nav_rssSection_list_li');

                    // title = document.createElement('p');
                    // title.classList.add('nav_rssSection_list_li_title');
                    icon = document.createElement('img');
                    icon.classList.add('nav_rssSection_list_li_fluxLogo');

                    if (source.sourceUrl.includes('jeuxactu'))
                        icon.src = 'data/img/fluxJa.png';
                    else if (source.sourceUrl.includes('lemonde'))
                        icon.src = 'data/img/fluxLm.png';
                    else if (source.sourceUrl)
                        icon.src = 'data/img/fluxDefault.png';

                    // fav = document.createElement('p');
                    fav = document.createElement('img');
                    fav.classList.add('nav_rssSection_list_li_fav');

                    itemFlux.id = source.id;
                    icon.addEventListener('click', function(ev){c.handlerClickFlux(source, ev.target)});

                    // fav.textContent = "ajouter en favori";
                    fav.src = 'data/svg/favEmpty.svg';
                    fav.addEventListener('click', function(ev){c.handlerFav(source, ev.target)});

                    itemFlux.appendChild(icon)
                    itemFlux.appendChild(fav);
                    v.fluxList.appendChild(itemFlux);
                }
            },

            renderArticles(articles) {
                v.itemList.innerHTML = '';
                if ((!articles) || (articles.length == 0)){
                    nothingScreen = document.createElement('p');
                    nothingScreen.textContent = 'CLIQUEZ SUR UN FLUX OU FAITES UNE RECHERCHE POUR FAIRE APPARAITRE DES ARTICLES !'
                    v.itemList.appendChild(nothingScreen);
                }
                else {
                    articles.forEach(e => {
                        itemArticle = document.createElement('li');
                        itemArticle.classList.add('itemSection_list_li');
                        
                        title = document.createElement('h3');
                        title.classList.add('itemSection_list_li_title');
                        desc = document.createElement('p');
                        desc.classList.add('itemSection_list_li_desc');
                        link = document.createElement('a');
                        link.classList.add('itemSection_list_li_link');
                        linkImg = document.createElement('a');
                        link.classList.add('itemSection_list_li_linkImg');
                        date = document.createElement('span');
                        date.classList.add('itemSection_list_li_date');

                        desc.textContent = e.article.description;
                        link.textContent = e.article.title;
                        link.href = e.article.link;
                        linkImg.href = e.article.link;
                        link.target = "_blank";
                        date.textContent = e.article.pubDate;

                        image = document.createElement('img');
                        image.classList.add('itemSection_list_li_img');
                        if(e.article.enclosure) {
                            image.src = e.article.enclosure["@attributes"].url;
                        } else if (e.article.mediacontent) {
                            image.src = e.article.mediacontent["@attributes"].url;
                        }
                        else {
                            image.src = 'data/img/placeholder.png'
                        }

                        itemArticle.id = e.id;

                        title.appendChild(link);
                        linkImg.appendChild(image);

                        itemArticle.appendChild(linkImg);
                        itemArticle.appendChild(title);
                        itemArticle.appendChild(date);
                        itemArticle.appendChild(desc);

                        v.itemList.appendChild(itemArticle);
                    });
                }

            },

            renderFav(source) {
                if (source.fav) {
                    document.querySelector('#'+source.id).querySelector('.nav_rssSection_list_li_fav').src = 'data/svg/favFull.svg';
                }
            },

            showOverlay: function() {
                v.addFluxOverlay.style.width = '100%';
                v.addFluxBox.style.width = 'fit-content';
                v.addFluxBox.style.display = 'flex';
            },

            hideOverlay: function() {
                v.addFluxOverlay.style.width = '0';
                v.addFluxBox.style.width = '0';
                v.addFluxBox.style.display = 'none';
            },

            fluxBrightness(target, value, type) {
                if (type == 'target') {
                    target.style = 'filter: brightness('+value+')';
                }else if (type == 'id'){
                    document.querySelector('#'+target+' .nav_rssSection_list_li_fluxLogo').style = 'filter: brightness('+value+')';
                }
            }

            // resetFluxBrightness() {
            //     fluxButton = document.getElementsByClassName('nav_rssSection_list_li_fluxLogo');
            //     fluxButtonLenght = fluxButton.lenght;
            //     console.log(fluxButtonLenght);
            //     fluxButton.forEach(e => {
            //         e.style = 'filter: brightness(.5)';
            //     });
            // }
        }
        
        // v.showOverlay();
        c.init();

    </script>
</body>
</html>