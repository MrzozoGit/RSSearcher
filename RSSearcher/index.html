<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSSearcher</title>
    <link href="style/style.css" rel="stylesheet">
</head>
<body>
    <input class="inputText" type="url" pattern="https?://.+.xml+" required></input>
    <input class="addButton" type="button" value="Ajouter">

    <h1 class="title">RSSearcher Jour 2</h1>

    <section class="rssSection">
        <h2 class="rssSection_title">Flux RSS</h2>
        <ul class="rssSection_list"></ul>
    </section>
    
    <section class="itemSection">
        <h2 class="itemSection_title">Liste des articles</h2>
        <ul class="itemSection_list"></ul>
    </section>
    
    <script>

        let m = {
            data: null,
            idCounter: null,
            sourcesList: [
                {
                    id: 'id0',
                    sourceUrl: 'https://www.jeuxactu.com/rss/ja.rss',
                    switch: false,
                    fav: false
                },
                {
                    id: 'id1',
                    sourceUrl: 'https://www.lemonde.fr/pixels/rss_full.xml',
                    switch: false,
                    fav: false
                },
                {
                    id: 'id2',
                    sourceUrl: 'https://www.lemonde.fr/jeux-video/rss_full.xml',
                    switch: false,
                    fav: false
                },
                {
                    id: 'id3',
                    sourceUrl: 'https://www.lemonde.fr/cultures-web/rss_full.xml',
                    switch: false,
                    fav: false
                }
            ],
            articleList: [],
            currentArticles: [],
            
            filterArticle: function() {
                m.currentArticles = [];
                sourcesSwitch = m.sourcesList.filter(e => e.switch == true)
                sourcesSwitch.forEach(source => {
                    m.articleList.filter(e => e.id == source.sourceUrl).forEach(f => {
                        m.currentArticles.push(f);
                    })
                })
                console.log(m.currentArticles);
            },

            addFlux: function(fluxToAdd) {
                m.sourcesList.push(fluxToAdd)
            },
            
            addFav: function(source, sw) {
                source.fav = sw;
                m.updateFav();
            },

            updateFav: function(){
                let favTab = []
                m.sourcesList.forEach(e => {
                    if (e.fav)
                        favTab.push(e.sourceUrl)
                });
                localStorage.setItem("favs", JSON.stringify(favTab))
            },

            initFav: function() {
                m.idCounter = 'id' + toString(m.sourcesList.length)
                favs = JSON.parse(localStorage.getItem("favs"))
                favs.forEach(e => {
                    m.sourcesList.forEach(f => {
                        if (f.sourceUrl == e)
                            f.fav = true
                    })
                });
            }
        }
        
        let c = {
            init: function() {
                m.initFav()
                m.sourcesList.forEach(e => {
                    c.fetchRSS(e)
                });
                v.init()
            },

            fetchRSS: function(source) {
                let xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.status==200 && xhr.readyState==4) {
                        m.data = JSON.parse(xhr.responseText)
                        v.renderFlux(m.data, source)
                        m.data.channel.item.forEach(e => {
                            m.articleList.push({'article': e, 'id': source.id})
                        });
                    }
                };
                xhr.open('get', "https://quentin-huet.fr/pt/script/getRss.php?flux=" + source.sourceUrl);
                xhr.send();
            },

            handlerClickFlux: function(source, target) {
                if (source.switch == false) {
                    source.switch = true;
                    m.filterArticle();
                    v.renderArticles(m.currentArticles);
                    target.style = 'color: #F00'
                } else {
                    source.switch = false;
                    m.filterArticle();
                    v.renderArticles(m.currentArticles);
                    target.style = 'color: #000'
                }
            },

            handlerAdd: function() {
                str = v.inputText.value
                if (str.includes("https://") || str.includes("http://") & str.includes(".xml")) {
                    tempObj = {'id': m.idCounter,'sourceUrl': str, 'switch': false, 'fav': false}
                    m.idCounter++;
                    c.fetchRSS(tempObj)
                    m.addFlux(tempObj)
                    v.inputText.value = "";
                }
            },

            handlerFav: function(source, target){
                if (source.fav == false){
                    m.addFav(source, true);
                    target.style = 'color: #F00';
                } else {
                    m.addFav(source, false);
                    target.style = 'color: #000';
                }
            }
        }

        let v = {
            fluxList: document.querySelector('.rssSection_list'),
            itemList: document.querySelector('.itemSection_list'),
            inputText: document.querySelector('.inputText'),
            addButton: document.querySelector('.addButton'),

            init: function() {
                v.addButton.addEventListener('click', c.handlerAdd)
                //v.renderFav();
            },

            renderFlux: function(flux, source) {
                // Rendu du titre dans la liste des flux
                itemFlux = document.createElement('li')
                itemFlux.classList.add('rssSection_list_li')

                title = document.createElement('p')
                title.classList.add('rssSection_list_li_title');
                fav = document.createElement('p');
                fav.classList.add('rssSection_list_li_fav');

                itemFlux.id = source.id
                title.textContent = flux.channel.title
                title.addEventListener('click', function(ev){c.handlerClickFlux(source, ev.target)})

                fav.textContent = "ajouter en favori";
                fav.addEventListener('click', function(ev){c.handlerFav(source, ev.target)});

                itemFlux.appendChild(title)
                itemFlux.appendChild(fav);
                v.fluxList.appendChild(itemFlux)

                v.renderFav();
            },

            renderArticles(articles) {
                v.itemList.innerHTML = '';
                articles.forEach(e => {
                    itemArticle = document.createElement('li')
                    itemArticle.classList.add('itemSection_list_li');
                    
                    title = document.createElement('h3')
                    title.classList.add('itemSection_list_li_title');
                    desc = document.createElement('p')
                    desc.classList.add('itemSection_list_li_desc');
                    link = document.createElement('a')
                    link.classList.add('itemSection_list_li_link');
                    date = document.createElement('span')
                    date.classList.add('itemSection_list_li_date');

                    title.textContent = e.article.title
                    desc.textContent = e.article.description
                    link.textContent = 'lien'
                    link.href = e.article.link
                    date.textContent = e.article.pubDate

                    image = document.createElement('img');
                    image.classList.add('itemSection_list_li_img')
                    image.src = e.article.enclosure["@attributes"].url;

                    itemArticle.id = e.id

                    itemArticle.appendChild(title)
                    itemArticle.appendChild(desc)
                    itemArticle.appendChild(link)
                    itemArticle.appendChild(date)

                    v.itemList.appendChild(itemArticle)
                });
            },

            renderFav(){
                m.sourcesList.forEach(e => {
                    if (e.fav) {
                        document.querySelector('#'+e.id).querySelector('.rssSection_list_li_fav').style = 'color: #F00';
                    }
                })
            }
        }

        c.init();

    </script>
</body>
</html>