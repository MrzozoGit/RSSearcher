<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSSearcher</title>
    <link href="style/style.css" rel="stylesheet">
</head>
<body>

    <h1 class="title">RSSearcher</h1>

    <section class="rss_section">
        <h2 class="rss_section_title">Flux RSS</h2>
        <ul class="rss_list"></ul>
    </section>

    <section class="item_section">
        <h2 class="item_section_title">Liste des articles</h2>
        <ul class="item_list"></ul>
    </section>

    <script>

        let m = {
            data: null,
            sourcesList: [
                {
                    sourceUrl: 'https://www.jeuxactu.com/rss/ja.rss',
                    switch: false
                },
                {
                    sourceUrl: 'https://www.lemonde.fr/pixels/rss_full.xml',
                    switch: false
                },
                {
                    sourceUrl: 'https://www.lemonde.fr/jeux-video/rss_full.xml',
                    switch: false
                },
                {
                    sourceUrl: 'https://www.lemonde.fr/cultures-web/rss_full.xml',
                    switch: false
                }
            ],
            articleList: [],
            currentArticles: [],
            
            filterArticle: function(){
                m.currentArticles = [];
                sourcesSwitch = m.sourcesList.filter(e => e.switch == true)
                sourcesSwitch.forEach(source => {
                    m.articleList.filter(e => e.id == source.sourceUrl).forEach(f => {
                        m.currentArticles.push(f);
                    })
                })
                console.log(m.currentArticles);
            }
        }
        
        let c = {
            init: function(){
                m.sourcesList.forEach(e => {
                    c.fetchRSS(e)
                });
            },

            fetchRSS: function(source){
                let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(){
                        if (xhr.status==200 && xhr.readyState==4){
                            m.data = JSON.parse(xhr.responseText)
                            v.renderFlux(m.data, source)
                            m.data.channel.item.forEach(e => {
                                m.articleList.push({'article': e, 'id': source.sourceUrl})
                            });
                        }
                    };
                    xhr.open('get', "https://quentin-huet.fr/pt/script/getRss.php?flux=" + source.sourceUrl);
                    xhr.send();
            },

            handlerClickFlux: function(source, target) {
                if(source.switch==false){
                    source.switch = true;
                    m.filterArticle();
                    v.renderArticles(m.currentArticles);
                    target.style = 'color: #F00'
                }else{
                    source.switch = false;
                    m.filterArticle();
                    v.renderArticles(m.currentArticles);
                    target.style = 'color: #000'
                }
            }
        }

        let v = {
            fluxList: document.querySelector('.rss_list'),
            itemList: document.querySelector('.item_list'),

            renderFlux: function(flux, source) {
                // Rendu du titre dans la liste des flux
                itemFlux = document.createElement('li')
                title = document.createElement('p')

                itemFlux.id = source.sourceUrl
                itemFlux.addEventListener('click', function(ev){c.handlerClickFlux(source, ev.target)})
                title.textContent = flux.channel.title

                itemFlux.appendChild(title)
                v.fluxList.appendChild(itemFlux)
            },

            renderArticles() {
                v.itemList.innerHTML = '';
                m.currentArticles.forEach(e => {
                    itemArticle = document.createElement('li')
                    
                    title = document.createElement('h3')
                    desc = document.createElement('p')
                    link = document.createElement('a')
                    date = document.createElement('span')

                    title.textContent = e.article.title
                    desc.textContent = e.article.description
                    link.textContent = 'lien'
                    link.href = e.article.link
                    date.textContent = e.article.pubDate

                    itemArticle.id = e.id

                    itemArticle.appendChild(title)
                    itemArticle.appendChild(desc)
                    itemArticle.appendChild(link)
                    itemArticle.appendChild(date)

                    v.itemList.appendChild(itemArticle)
                });
            }
        }

        c.init();

    </script>
</body>
</html>